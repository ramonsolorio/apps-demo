IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND OBJECT_ID = OBJECT_ID('dbo.SP_GET_PROMOTION_DATA'))
	DROP PROCEDURE [dbo].[SP_GET_PROMOTION_DATA]
GO

CREATE PROCEDURE [dbo].[SP_GET_PROMOTION_DATA]
	@BatchID DECIMAL = 190913,
	@Location DECIMAL = 20849,
	@LoadBatchID DECIMAL = 122146421
AS
BEGIN
	DECLARE @TableName nvarchar(255) = NEWID()

	CREATE TABLE #@TableName(
		[BATCH_ID] DECIMAL NULL,
		[LOCATION] DECIMAL NULL,
		[ARCHIVO] [nvarchar](255) NULL,
		[LOAD_DATE] [datetime2] NULL,
		[LOAD_WEEK] DECIMAL NULL,
		[LOAD_BATCH_ID] DECIMAL NULL,
		[WM_PRM_STATUS] [nvarchar](1) NULL,
		[WM_TARGET_PRM] [nvarchar](255) NULL,
		[STORE] DECIMAL(10) NULL,
		[UPDATE_TYPE] DECIMAL NULL,
		[START_DATE] [datetime2] NULL,
		[END_DATE] [datetime2] NULL,
		[TIME] [datetime2] NULL,
		[END_TIME] [datetime2] NULL,
		[TRAN_TYPE] DECIMAL(2) NULL,
		[ITEM] [nvarchar](25) NULL,
		[ITEM_NUMBER_TYPE] [nvarchar](6) NULL,
		[FORMAT_ID] [nvarchar](1) NULL,
		[PREFIX] DECIMAL(2) NULL,
		[REF_ITEM] [nvarchar](25) NULL,
		[REF_ITEM_NUMBER_TYPE] [nvarchar](6) NULL,
		[REF_FORMAT_ID] [nvarchar](1) NULL,
		[REF_PREFIX] DECIMAL(2) NULL,
		[ITEM_SHORT_DESC] [nvarchar](20) NULL,
		[ITEM_LONG_DESC] [nvarchar](100) NULL,
		[DEPT] DECIMAL(4) NULL,
		[CLASS] DECIMAL(4) NULL,
		[SUBCLASS] DECIMAL(4) NULL,
		[NEW_PRICE] DECIMAL(20,4) NULL,
		[NEW_SELLING_UOM] [nvarchar](4) NULL,
		[NEW_MULTI_UNITS] DECIMAL(12,4) NULL,
		[NEW_MULTI_UNIT_RETAIL] DECIMAL(12,4) NULL,
		[NEW_MULTI_SELLING_UOM] [nvarchar](4) NULL,
		[STATUS] [nvarchar](1) NULL,
		[TAXABLE_IND] [nvarchar](1) NULL,
		[PROMOTION] DECIMAL(10) NULL,
		[MIX_MATCH_NO] DECIMAL(10) NULL,
		[MIX_MATCH_TYPE] [nvarchar](1) NULL,
		[THRESHOLD_NO] DECIMAL(10) NULL,
		[LAUNCH_DATE] [nvarchar](8) NULL,
		[QTY_KEY_OPTIONS] [nvarchar](6) NULL,
		[MANUAL_PRICE_ENTRY] [nvarchar](6) NULL,
		[DEPOSIT_CODE] [nvarchar](6) NULL,
		[FOOD_STAMP_IND] [nvarchar](1) NULL,
		[WIC_IND] [nvarchar](2) NULL,
		[PROPORTIONAL_TARE_PCT] DECIMAL(12,4) NULL,
		[FIXED_TARE_VALUE] DECIMAL(12,4) NULL,
		[FIXED_TARE_UOM] [nvarchar](4) NULL,
		[REWARD_ELIGIBLE_IND] [nvarchar](1) NULL,
		[ELECT_MTK_CLUBS] [nvarchar](6) NULL,
		[RETURN_POLICY] [nvarchar](6) NULL,
		[STOP_SALE_IND] [nvarchar](1) NULL,
		[RETURNABLE_IND] [nvarchar](1) NULL,
		[REFUNDABLE_IND] [nvarchar](1) NULL,
		[BACK_ORDER_IND] [nvarchar](1) NULL,
		[VAT_CODE] [nvarchar](6) NULL,
		[VAT_RATE] DECIMAL(20,10) NULL,
		[CLASS_VAT_IND] [nvarchar](1) NULL,
		[LINE_ID] DECIMAL NULL,
		[LOAD_TIMESTAMP] [datetime2] NULL,
		[MSG_POS] [nvarchar](38) NULL,
		[PROM_BIN_CODE] [nvarchar](11) NULL,
		[PROM_NAME] [nvarchar](40) NULL,
		[PROM_TRAN_TYPE] [nvarchar](6) NULL,
		[START_TIME] [datetime2] NULL,
		[APPLY_TO] [nvarchar](1) NULL,
		[BUY_TYPE] [nvarchar](1) NULL,
		[BUY_AMT] DECIMAL(20,4) NULL,
		[GET_TYPE] [nvarchar](1) NULL,
		[GET_AMT] DECIMAL(20,4) NULL,
		[SELLING_UOM] [nvarchar](2) NULL,
		[THRESHOLD_AMT] DECIMAL(20,4) NULL,
		[DISCOUNT_AMT] DECIMAL(20,4) NULL,
		[DISCOUNT_TYPE] [nvarchar](1) NULL,
		[ORACLE_CR] [nvarchar](30) NULL,
		[ORACLE_CR_DESC] [nvarchar](100) NULL,
		[ORACLE_CR_SUPERIOR] [nvarchar](30) NULL,
		[ORACLE_CR_TYPE] [nvarchar](1) NULL,
		[ESTADO] [nvarchar](1) NULL,
		[RETEK_CR] DECIMAL NULL,
		[RETEK_ASESOR] DECIMAL NULL,
		[RETEK_ASESOR_NOMBRE] [nvarchar](50) NULL,
		[RETEK_DISTRITO] DECIMAL NULL,
		[RETEK_PLAZA] DECIMAL NULL,
		[RETEK_STATUS] [nvarchar](1) NULL,
		[SURH_CR] DECIMAL(5) NULL,
		[SURH_FLAG] [nvarchar](1) NULL,
		[CR_FLEX_VALUE_ID] DECIMAL(15) NULL,
		[ORACLE_EF] [nvarchar](240) NULL,
		[ORACLE_EF_DESC] [nvarchar](100) NULL,
		[EF_FLEX_VALUE_ID] DECIMAL(15) NULL,
		[ORACLE_CIA] [nvarchar](240) NULL,
		[ORACLE_CIA_DESC] [nvarchar](100) NULL,
		[CIA_FLEX_VALUE_ID] DECIMAL(15) NULL,
		[ID_ESTADO_FINANCIERO] [nvarchar](240) NULL,
		[ID_CENTRO_RESPONSABILIDAD] DECIMAL(15) NULL,
		[ID_COMPANIA] DECIMAL(15) NULL,
		[LEGACY_EF] [nvarchar](2) NULL,
		[LEGACY_CR] [nvarchar](3) NULL
	)

	INSERT INTO #@TableName
		SELECT
			@BatchID AS [BATCH_ID],
			@Location AS [LOCATION],
			(SELECT TOP 1 ARCHIVO FROM [dbo].[CO_PRM_DAT_HDR] WHERE BATCH_ID = @BatchID and LOCATION = @Location) AS [ARCHIVO],
			(SELECT TOP 1 LOAD_DATE FROM [dbo].[CO_PRM_DAT_HDR] WHERE BATCH_ID = @BatchID and LOCATION = @Location) AS [LOAD_DATE],
			(SELECT TOP 1 LOAD_WEEK FROM [dbo].[CO_PRM_DAT_HDR] WHERE BATCH_ID = @BatchID and LOCATION = @Location) AS [LOAD_WEEK],
			@LoadBatchID AS [LOAD_BATCH_ID],
			(SELECT TOP 1 WM_PRM_STATUS FROM [dbo].[CO_PRM_DAT_HDR] WHERE BATCH_ID = @BatchID and LOCATION = @Location) AS [WM_PRM_STATUS],
			(SELECT TOP 1 WM_TARGET_PRM FROM [dbo].[CO_PRM_DAT_HDR] WHERE BATCH_ID = @BatchID and LOCATION = @Location) AS [WM_TARGET_PRM],
			d.[STORE],
			d.[UPDATE_TYPE],
			d.[START_DATE],
			d.[END_DATE],
			d.[TIME],
			d.[END_TIME],
			d.[TRAN_TYPE],
			d.[ITEM],
			d.[ITEM_NUMBER_TYPE],
			d.[FORMAT_ID],
			d.[PREFIX],
			d.[REF_ITEM],
			d.[REF_ITEM_NUMBER_TYPE],
			d.[REF_FORMAT_ID],
			d.[REF_PREFIX],
			d.[ITEM_SHORT_DESC],
			d.[ITEM_LONG_DESC],
			d.[DEPT],
			d.[CLASS],
			d.[SUBCLASS],
			d.[NEW_PRICE],
			d.[NEW_SELLING_UOM],
			d.[NEW_MULTI_UNITS],
			d.[NEW_MULTI_UNIT_RETAIL],
			d.[NEW_MULTI_SELLING_UOM],
			d.[STATUS],
			d.[TAXABLE_IND],
			CAST(d.[PROMOTION] AS int) AS PROMOTION,
			d.[MIX_MATCH_NO],
			d.[MIX_MATCH_TYPE],
			d.[THRESHOLD_NO],
			d.[LAUNCH_DATE],
			d.[QTY_KEY_OPTIONS],
			d.[MANUAL_PRICE_ENTRY],
			d.[DEPOSIT_CODE],
			d.[FOOD_STAMP_IND],
			d.[WIC_IND],
			d.[PROPORTIONAL_TARE_PCT],
			d.[FIXED_TARE_VALUE],
			d.[FIXED_TARE_UOM],
			d.[REWARD_ELIGIBLE_IND],
			d.[ELECT_MTK_CLUBS],
			d.[RETURN_POLICY],
			d.[STOP_SALE_IND],
			d.[RETURNABLE_IND],
			d.[REFUNDABLE_IND],
			d.[BACK_ORDER_IND],
			d.[VAT_CODE],
			d.[VAT_RATE],
			d.[CLASS_VAT_IND],
			d.[LINE_ID],
			d.[LOAD_TIMESTAMP],
			d.[MSG_POS],
			d.[PROM_BIN_CODE],
			d.[PROM_NAME],
			NULL AS PROM_TRAN_TYPE,
			NULL AS START_TIME,
			NULL AS APPLY_TO,
			NULL AS BUY_TYPE,
			NULL AS BUY_AMT,
			NULL AS GET_TYPE,
			NULL AS GET_AMT,
			NULL AS SELLING_UOM,
			NULL AS THRESHOLD_AMT,
			NULL AS DISCOUNT_AMT,
			NULL AS DISCOUNT_TYPE,
			x.[ORACLE_CR],
			x.[ORACLE_CR_DESC],
			x.[ORACLE_CR_SUPERIOR],
			x.[ORACLE_CR_TYPE],
			x.[ESTADO],
			x.[RETEK_CR],
			x.[RETEK_ASESOR],
			x.[RETEK_ASESOR_NOMBRE],
			x.[RETEK_DISTRITO],
			x.[RETEK_PLAZA],
			x.[RETEK_STATUS],
			x.[SURH_CR],
			x.[SURH_FLAG],
			x.[CR_FLEX_VALUE_ID],
			x.[ORACLE_EF],
			x.[ORACLE_EF_DESC],
			x.[EF_FLEX_VALUE_ID],
			x.[ORACLE_CIA],
			x.[ORACLE_CIA_DESC],
			x.[CIA_FLEX_VALUE_ID],
			x.[ID_ESTADO_FINANCIERO],
			x.[ID_CENTRO_RESPONSABILIDAD],
			x.[ID_COMPANIA],
			x.[LEGACY_EF],
			x.[LEGACY_CR]
		FROM [dbo].[CO_PRM_DAT] d
		JOIN [dbo].[CO_ERDD_MCRS] x ON x.RETEK_CR = d.[STORE]
		WHERE d.[LOAD_WEEK] IN (SELECT TOP 1 [LOAD_WEEK] FROM [dbo].[CO_PRM_DAT_HDR] WHERE BATCH_ID = @BatchID and LOCATION = @Location) and
		      d.[LOAD_BATCH_ID] = @LoadBatchID

	UPDATE t
	SET
		t.PROM_TRAN_TYPE = d.PROM_TRAN_TYPE,
		t.START_TIME = d.START_TIME,
		t.APPLY_TO = d.APPLY_TO,
		t.BUY_TYPE = d.BUY_TYPE,
		t.BUY_AMT = d.BUY_AMT,
		t.GET_TYPE = d.GET_TYPE,
		t.GET_AMT = d.GET_AMT,
		t.SELLING_UOM = d.SELLING_UOM,
		t.THRESHOLD_AMT = d.THRESHOLD_AMT,
		t.DISCOUNT_AMT = d.DISCOUNT_AMT,
		t.DISCOUNT_TYPE = d.DISCOUNT_TYPE
	FROM #@TableName t
	INNER JOIN CO_PRM_DAT_DTL d ON d.STORE = t.STORE and d.LOAD_BATCH_ID = t.LOAD_BATCH_ID and d.LOAD_WEEK = t.LOAD_WEEK

	SELECT * FROM #@TableName
	ORDER BY [LOAD_BATCH_ID], [STORE], [LOAD_TIMESTAMP]

	DROP TABLE IF EXISTS #@TableName
END
